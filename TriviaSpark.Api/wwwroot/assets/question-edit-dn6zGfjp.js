import{c as C,u as le,a as ce,b as oe,r as c,j as e,X as de}from"./index-DI_V0N2n.js";import{u as A}from"./useQuery-uMtYOOT2.js";import{u as P}from"./useMutation-Bmn-u3uu.js";import{u as me,S as V,a as $,b as O,c as z,d as p}from"./select-Cgzjh8Un.js";import{C as b,a as k,b as S,c as q}from"./card-BEmG5nHS.js";import{B as h}from"./button--Wx2SMIH.js";import{L as r,I as g}from"./label-CTF6Khh0.js";import{T as M}from"./textarea-DGMF1vTh.js";import{A as D}from"./arrow-left-DTeuy0ly.js";import{S as ue}from"./save-DBIG6Hr0.js";import"./index-BdQq_4o_.js";import"./index-CzTbsjjR.js";import"./Combination-BaQj-MRz.js";import"./chevron-up-QVsKHy8w.js";/**
 * @license lucide-react v0.544.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const xe=[["path",{d:"M12 15V3",key:"m9g1x1"}],["path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4",key:"ih7n3h"}],["path",{d:"m7 10 5 5 5-5",key:"brsn70"}]],he=C("download",xe);/**
 * @license lucide-react v0.544.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ge=[["path",{d:"M2.062 12.348a1 1 0 0 1 0-.696 10.75 10.75 0 0 1 19.876 0 1 1 0 0 1 0 .696 10.75 10.75 0 0 1-19.876 0",key:"1nclc0"}],["circle",{cx:"12",cy:"12",r:"3",key:"1v7zrd"}]],pe=C("eye",ge);/**
 * @license lucide-react v0.544.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const fe=[["path",{d:"m21 21-4.34-4.34",key:"14j7rj"}],["circle",{cx:"11",cy:"11",r:"8",key:"4ej97u"}]],je=C("search",fe),Qe=({eventId:o,questionId:n})=>{const[,j]=le(),{toast:f}=ce(),B=oe(),{register:m,handleSubmit:R,setValue:v,watch:d,reset:I,formState:{errors:l,isDirty:H}}=me({defaultValues:{questionType:"game"}}),[N,T]=c.useState(["","","",""]),[w,K]=c.useState(""),[E,G]=c.useState([]),[J,U]=c.useState(!1),[a,X]=c.useState(null),[W,F]=c.useState(!1),[Y,Z]=c.useState({unsplashImageId:"",sizeVariant:"regular",usageContext:"question_background",searchContext:""}),{data:Q,isLoading:ee}=A({queryKey:["/api/events",o,"questions"],queryFn:async()=>{const s=await fetch(`/api/events/${o}/questions`,{credentials:"include"});if(!s.ok)throw new Error("Failed to fetch questions");return s.json()},enabled:!!o}),t=Q?.find(s=>s.id===n);console.log("QuestionEdit: Current state",{questionId:n,questionsCount:Q?.length,question:t,questionDifficulty:t?.difficulty,formDifficulty:d("difficulty")});const{data:u,refetch:se}=A({queryKey:["/api/questions",n,"eventimage"],queryFn:async()=>{const s=await fetch(`/api/questions/${n}/eventimage`,{credentials:"include"});if(!s.ok)throw new Error("Failed to fetch event image");return s.json()},enabled:!!n});c.useEffect(()=>{console.log("QuestionEdit: question data changed",{questionId:n,question:t,difficulty:t?.difficulty}),t&&(console.log("Setting form values:",{difficulty:t.difficulty,question:t.question,allValues:t}),I({question:t.question,correctAnswer:t.correctAnswer,points:t.points,timeLimit:t.timeLimit,difficulty:t.difficulty,category:t.category,explanation:t.explanation||"",orderIndex:t.orderIndex,backgroundImageUrl:t.backgroundImageUrl||"",questionType:t.questionType||"game"}),T(t.options||["","","",""]),setTimeout(()=>{console.log("Form values after reset:",{difficulty:d("difficulty"),question:d("question"),allFormValues:d()})},100))},[t,n,I,d]),c.useEffect(()=>{if(u?.eventImage){const s=u.eventImage;Z({unsplashImageId:s.unsplashImageId||"",sizeVariant:s.sizeVariant||"regular",usageContext:s.usageContext||"question_background",searchContext:s.searchContext||""})}},[u]);const y=P({mutationFn:async s=>{const i={Question:s.question,Type:t?.type||"multiple_choice",Options:N.filter(ne=>ne.trim()!==""),CorrectAnswer:s.correctAnswer,Difficulty:s.difficulty,Category:s.category,Explanation:s.explanation,TimeLimit:s.timeLimit,OrderIndex:s.orderIndex,AiGenerated:t?.aiGenerated,BackgroundImageUrl:s.backgroundImageUrl||null,SelectedImage:a?{Id:a.id,Author:a.user.name,AuthorUrl:a.user.links.html,PhotoUrl:a.urls.regular,DownloadUrl:a.links.download_location||""}:null,QuestionType:s.questionType||"game"},x=await fetch(`/api/questions/${n}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(i),credentials:"include"});if(!x.ok)throw new Error("Failed to update question");return x.json()},onSuccess:()=>{B.invalidateQueries({queryKey:["/api/events",o,"questions"]}),f({title:"Success",description:"Question updated successfully"}),j(`/events/${o}/manage/trivia`)},onError:s=>{f({title:"Error",description:s.message||"Failed to update question",variant:"destructive"})}}),te=P({mutationFn:async()=>{if(!a)return;const s={NewUnsplashImageId:a.id,SizeVariant:Y.sizeVariant,SelectedByUserId:"mark-user-id"},i=await fetch(`/api/EventImages/question/${n}/replace`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(s),credentials:"include"});if(!i.ok)throw new Error("Failed to save event image");return i.json()},onSuccess:()=>{se(),f({title:"Success",description:"Event image saved successfully"})},onError:s=>{f({title:"Error",description:s.message||"Failed to save event image",variant:"destructive"})}}),L=async()=>{if(w.trim()){U(!0);try{const s=await fetch(`/api/unsplash/search?query=${encodeURIComponent(w)}&perPage=12`);if(!s.ok)throw new Error("Search failed");const i=await s.json();G(i.results||[])}catch(s){f({title:"Search Error",description:s.message,variant:"destructive"})}finally{U(!1)}}},ae=async s=>{if(s.links.download_location)try{await fetch("/api/unsplash/track-download",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({downloadUrl:s.links.download_location}),credentials:"include"})}catch(i){console.warn("Failed to track download:",i)}},ie=async s=>{X(s),v("backgroundImageUrl",s.urls.regular),await ae(s)},re=(s,i)=>{const x=[...N];x[s]=i,T(x)},_=R(async s=>{a&&await te.mutateAsync(),y.mutate(s)});return ee?e.jsx("div",{className:"min-h-screen bg-gradient-to-br from-wine-50 to-champagne-50 flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin h-8 w-8 border-b-2 border-wine-600 rounded-full mx-auto mb-4"}),e.jsx("p",{className:"text-muted-foreground",children:"Loading question..."})]})}):t?e.jsx("div",{className:"min-h-screen bg-gradient-to-br from-wine-50 to-champagne-50",children:e.jsxs("div",{className:"max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-8",children:[e.jsxs("div",{className:"flex items-center justify-between mb-8",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs(h,{variant:"ghost",onClick:()=>j(`/events/${o}/manage/trivia`),className:"text-wine-600 hover:text-wine-700 hover:bg-wine-50",children:[e.jsx(D,{className:"mr-2 h-4 w-4"}),"Back to Trivia Management"]}),e.jsx("h1",{className:"text-3xl font-bold text-wine-900",children:"Edit Question"})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(h,{type:"button",variant:"outline",onClick:()=>j(`/events/${o}/manage/trivia`),disabled:y.isPending,children:"Cancel"}),e.jsxs(h,{onClick:_,disabled:y.isPending||!H,className:"bg-wine-600 hover:bg-wine-700",children:[e.jsx(ue,{className:"mr-2 h-4 w-4"}),y.isPending?"Saving...":"Save Question"]})]})]}),e.jsxs("form",{onSubmit:_,className:"grid grid-cols-1 lg:grid-cols-3 gap-8",children:[e.jsx("div",{className:"lg:col-span-2 space-y-6",children:e.jsxs(b,{children:[e.jsx(k,{children:e.jsx(S,{children:"Question Details"})}),e.jsxs(q,{className:"space-y-6",children:[e.jsxs("div",{children:[e.jsx(r,{htmlFor:"question",className:"text-sm font-medium",children:"Question Text *"}),e.jsx(M,{id:"question",rows:4,...m("question",{required:"Question text is required"}),className:"mt-1",placeholder:"Enter your trivia question here..."}),l.question&&e.jsx("p",{className:"text-red-500 text-sm mt-1",children:l.question.message})]}),t.type==="multiple_choice"&&e.jsxs("div",{children:[e.jsx(r,{className:"text-sm font-medium",children:"Answer Options"}),e.jsx("div",{className:"mt-2 space-y-3",children:N.map((s,i)=>e.jsxs("div",{className:"flex gap-3 items-center",children:[e.jsx("span",{className:"w-8 h-8 rounded bg-wine-100 flex items-center justify-center text-sm font-semibold text-wine-700",children:String.fromCharCode(65+i)}),e.jsx(g,{value:s,onChange:x=>re(i,x.target.value),placeholder:`Option ${String.fromCharCode(65+i)}`,className:"flex-1"})]},i))})]}),e.jsxs("div",{children:[e.jsx(r,{htmlFor:"correctAnswer",className:"text-sm font-medium",children:"Correct Answer *"}),e.jsx(g,{id:"correctAnswer",...m("correctAnswer",{required:"Correct answer is required"}),className:"mt-1",placeholder:"Enter the correct answer"}),l.correctAnswer&&e.jsx("p",{className:"text-red-500 text-sm mt-1",children:l.correctAnswer.message})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsx(r,{htmlFor:"points",className:"text-sm font-medium",children:"Points"}),e.jsx(g,{id:"points",type:"number",min:1,max:500,...m("points",{required:"Points are required",min:{value:1,message:"Points must be at least 1"},max:{value:500,message:"Points cannot exceed 500"}}),className:"mt-1"}),l.points&&e.jsx("p",{className:"text-red-500 text-sm mt-1",children:l.points.message})]}),e.jsxs("div",{children:[e.jsx(r,{htmlFor:"timeLimit",className:"text-sm font-medium",children:"Time Limit (seconds)"}),e.jsx(g,{id:"timeLimit",type:"number",min:5,max:300,...m("timeLimit",{required:"Time limit is required",min:{value:5,message:"Time limit must be at least 5 seconds"},max:{value:300,message:"Time limit cannot exceed 300 seconds"}}),className:"mt-1"}),l.timeLimit&&e.jsx("p",{className:"text-red-500 text-sm mt-1",children:l.timeLimit.message})]}),e.jsxs("div",{children:[e.jsx(r,{htmlFor:"orderIndex",className:"text-sm font-medium",children:"Order #"}),e.jsx(g,{id:"orderIndex",type:"number",min:1,...m("orderIndex",{required:"Order index is required",min:{value:1,message:"Order must be at least 1"}}),className:"mt-1"}),l.orderIndex&&e.jsx("p",{className:"text-red-500 text-sm mt-1",children:l.orderIndex.message})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsx(r,{htmlFor:"difficulty",className:"text-sm font-medium",children:"Difficulty"}),e.jsxs(V,{value:d("difficulty"),onValueChange:s=>v("difficulty",s,{shouldDirty:!0}),children:[e.jsx($,{className:"mt-1",children:e.jsx(O,{placeholder:"Select difficulty"})}),e.jsxs(z,{children:[e.jsx(p,{value:"easy",children:"Easy"}),e.jsx(p,{value:"medium",children:"Medium"}),e.jsx(p,{value:"hard",children:"Hard"})]})]}),e.jsxs("div",{className:"text-xs text-muted-foreground mt-1",children:["Debug: ",d("difficulty")]})]}),e.jsxs("div",{children:[e.jsx(r,{htmlFor:"questionType",className:"text-sm font-medium",children:"Question Type"}),e.jsxs(V,{value:d("questionType")||"game",onValueChange:s=>v("questionType",s,{shouldDirty:!0}),children:[e.jsx($,{className:"mt-1",children:e.jsx(O,{placeholder:"Select question type"})}),e.jsxs(z,{children:[e.jsx(p,{value:"game",children:"Game"}),e.jsx(p,{value:"training",children:"Training"}),e.jsx(p,{value:"tie-breaker",children:"Tie-breaker"})]})]})]}),e.jsxs("div",{children:[e.jsx(r,{htmlFor:"category",className:"text-sm font-medium",children:"Category"}),e.jsx(g,{id:"category",...m("category"),className:"mt-1",placeholder:"e.g., History, Science, Sports"})]})]}),e.jsxs("div",{children:[e.jsx(r,{htmlFor:"explanation",className:"text-sm font-medium",children:"Explanation (optional)"}),e.jsx(M,{id:"explanation",rows:3,...m("explanation"),className:"mt-1",placeholder:"Provide additional context or explanation for the answer..."})]})]})]})}),e.jsxs("div",{className:"space-y-6",children:[e.jsxs(b,{children:[e.jsx(k,{children:e.jsx(S,{className:"text-lg",children:"Question Image"})}),e.jsxs(q,{className:"space-y-4",children:[t.backgroundImageUrl?e.jsxs("div",{className:"relative",children:[e.jsx("img",{src:t.backgroundImageUrl,alt:"Question background",className:"w-full h-40 object-cover rounded-lg"}),e.jsx(h,{type:"button",variant:"secondary",size:"sm",className:"absolute top-2 right-2",onClick:()=>F(!0),children:e.jsx(pe,{className:"h-4 w-4"})})]}):e.jsx("div",{className:"w-full h-40 bg-gray-100 rounded-lg flex items-center justify-center text-gray-500",children:"No image selected"}),e.jsxs("div",{className:"space-y-3",children:[e.jsx(r,{className:"text-sm font-medium",children:"Search Unsplash"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(g,{value:w,onChange:s=>K(s.target.value),placeholder:"Search for images...",onKeyDown:s=>s.key==="Enter"&&L()}),e.jsx(h,{type:"button",onClick:L,disabled:J,size:"sm",children:e.jsx(je,{className:"h-4 w-4"})})]})]}),E.length>0&&e.jsxs("div",{className:"space-y-3",children:[e.jsx(r,{className:"text-sm font-medium",children:"Search Results"}),e.jsx("div",{className:"grid grid-cols-2 gap-2 max-h-96 overflow-y-auto",children:E.map(s=>e.jsxs("div",{className:`relative cursor-pointer border-2 rounded-lg overflow-hidden transition-all ${a?.id===s.id?"border-wine-500 ring-2 ring-wine-200":"border-gray-200 hover:border-gray-300"}`,onClick:()=>ie(s),children:[e.jsx("img",{src:s.urls.thumb,alt:s.alt_description||s.description||"Unsplash image",className:"w-full h-24 object-cover"}),a?.id===s.id&&e.jsx("div",{className:"absolute inset-0 bg-wine-500 bg-opacity-20 flex items-center justify-center",children:e.jsx("div",{className:"bg-white rounded-full p-1",children:e.jsx(he,{className:"h-4 w-4 text-wine-600"})})})]},s.id))})]}),a&&e.jsx("div",{className:"p-3 bg-gray-50 rounded-lg",children:e.jsxs("p",{className:"text-xs text-gray-600",children:["Photo by"," ",e.jsx("a",{href:`${a.user.links.html}?utm_source=TriviaSpark&utm_medium=referral`,target:"_blank",rel:"noreferrer",className:"underline text-wine-600 hover:text-wine-700",children:a.user.name})," ","on"," ",e.jsx("a",{href:`${a.links.html}?utm_source=TriviaSpark&utm_medium=referral`,target:"_blank",rel:"noreferrer",className:"underline text-wine-600 hover:text-wine-700",children:"Unsplash"})]})})]})]}),u&&e.jsxs(b,{children:[e.jsx(k,{children:e.jsx(S,{className:"text-lg",children:"Event Image Record"})}),e.jsx(q,{className:"space-y-4",children:e.jsxs("div",{className:"text-xs space-y-2",children:[e.jsxs("div",{children:[e.jsx(r,{className:"text-xs font-medium",children:"Image ID:"}),e.jsx("p",{className:"text-gray-600",children:u.eventImage?.unsplashImageId||"None"})]}),e.jsxs("div",{children:[e.jsx(r,{className:"text-xs font-medium",children:"Size Variant:"}),e.jsx("p",{className:"text-gray-600",children:u.eventImage?.sizeVariant||"regular"})]}),e.jsxs("div",{children:[e.jsx(r,{className:"text-xs font-medium",children:"Usage Context:"}),e.jsx("p",{className:"text-gray-600",children:u.eventImage?.usageContext||"question_background"})]})]})})]})]})]},n),W&&t.backgroundImageUrl&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"relative max-w-4xl max-h-full",children:[e.jsx("img",{src:t.backgroundImageUrl,alt:"Question background preview",className:"max-w-full max-h-full object-contain"}),e.jsx(h,{variant:"secondary",size:"sm",className:"absolute top-4 right-4",onClick:()=>F(!1),children:e.jsx(de,{className:"h-4 w-4"})})]})})]})}):e.jsx("div",{className:"min-h-screen bg-gradient-to-br from-wine-50 to-champagne-50 flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-muted-foreground mb-4",children:"Question not found"}),e.jsxs(h,{onClick:()=>j(`/events/${o}/manage/trivia`),children:[e.jsx(D,{className:"mr-2 h-4 w-4"}),"Back to Trivia Management"]})]})})};export{Qe as default};
